<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Client Database - Aftab Legal Group</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --panel2:#0d1730;
      --text:#eaf0ff;
      --muted:#a9b6d6;
      --line:rgba(255,255,255,.08);
      --primary:#4da3ff;
      --primary2:#2d6bff;
      --ok:#2bd576;
      --warn:#ffcc66;
      --bad:#ff5c6c;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: var(--font);
      background: radial-gradient(1200px 700px at 70% -10%, rgba(77,163,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 0% 0%, rgba(45,107,255,.18), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    .wrap{ max-width:1200px; margin:28px auto; padding:0 16px 50px; }
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:16px 18px; border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top: 10px; backdrop-filter: blur(10px);
      z-index: 5;
    }
    .title{ display:flex; flex-direction:column; gap:6px; }
    .title h1{ margin:0; font-size:18px; letter-spacing:.3px; }
    .title .sub{ color:var(--muted); font-size:12px; }
    .actions{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; justify-content:flex-end;}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
      transition: .15s ease;
      user-select: none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(77,163,255,.95), rgba(45,107,255,.95));
      border-color: rgba(255,255,255,.12);
      box-shadow: 0 10px 26px rgba(45,107,255,.22);
    }
    .btn.primary:hover{ filter: brightness(1.05); }
    .btn.danger{ background: rgba(255,92,108,.12); border-color: rgba(255,92,108,.22); }
    .btn.ok{ background: rgba(43,213,118,.12); border-color: rgba(43,213,118,.22); }
    .btn.small{ padding:8px 10px; border-radius: 12px; font-size:12px; }

    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.2fr .9fr .9fr 1fr;
      margin-top:14px;
    }
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h3{ margin:0 0 10px; font-size:13px; color: var(--muted); font-weight:600;}
    .row{ display:flex; gap:10px; align-items:center; flex-wrap: wrap;}
    .field{
      width: 100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      outline: none;
      font-size:13px;
    }
    .field:focus{ border-color: rgba(77,163,255,.55); box-shadow: 0 0 0 4px rgba(77,163,255,.12); }
    select.field{ cursor:pointer; }
    .tableWrap{
      margin-top:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    table{ width:100%; border-collapse: collapse; }
    thead th{
      text-align:right;
      font-size:12px;
      color: var(--muted);
      font-weight:600;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.04);
      position: sticky; top: 86px; z-index: 3; backdrop-filter: blur(8px);
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align: top;
    }
    tbody tr:hover{ background: rgba(255,255,255,.03); }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      font-size:12px;
      color: var(--text);
      white-space: nowrap;
    }
    .tag.ok{ border-color: rgba(43,213,118,.30); background: rgba(43,213,118,.10); }
    .tag.warn{ border-color: rgba(255,204,102,.30); background: rgba(255,204,102,.10); }
    .tag.bad{ border-color: rgba(255,92,108,.30); background: rgba(255,92,108,.10); }
    .muted{ color: var(--muted); font-size:12px; }
    .nowrap{ white-space: nowrap; }
    .cell-actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start; }
    .kpi{
      display:flex; flex-direction:column; gap:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:12px;
    }
    .kpi .v{ font-size:18px; font-weight:700; }
    .kpi .l{ font-size:12px; color: var(--muted); }
    .kpis{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      thead th{ top: 126px; }
      .kpis{ grid-template-columns: repeat(2, 1fr); }
    }

    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 50;
    }
    .modal{
      width: min(880px, 100%);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,27,51,.96), rgba(13,23,48,.96));
      border-radius: 18px;
      box-shadow: 0 26px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHeader{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .modalHeader .mhTitle{ font-size:14px; font-weight:700; }
    .modalBody{ padding:14px 16px 4px; }
    .formGrid{
      display:grid; gap:10px;
      grid-template-columns: 1fr 1fr 1fr;
    }
    .formRow{ display:flex; flex-direction:column; gap:6px; }
    .label{ color: var(--muted); font-size:12px; }
    textarea.field{ min-height: 90px; resize: vertical; }
    .modalFooter{
      display:flex; gap:10px; justify-content:flex-end; flex-wrap: wrap;
      padding:12px 16px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    @media (max-width: 980px){
      .formGrid{ grid-template-columns: 1fr; }
    }
    .hint{ margin:10px 0 0; color: var(--muted); font-size:12px; line-height:1.7; }
    .toast{
      position:fixed; right:18px; bottom:18px;
      background: rgba(15,27,51,.95);
      border:1px solid var(--line);
      color: var(--text);
      padding:12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 60;
      min-width: 240px;
    }
    .toast .t{ font-weight:700; font-size:13px; margin-bottom:4px;}
    .toast .d{ color: var(--muted); font-size:12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Client Database</h1>
        <div class="sub">Ù†Ø³Ø®Ù‡ MVP (IndexedDB) â€” Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø®Ø§Ù… Ø§Ø³Øª Ùˆ ÙÙ‚Ø· Ø¨Ø§ Ø«Ø¨Øª Ø´Ù…Ø§ Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
      </div>
      <div class="actions">
        <button class="btn" id="btnExport">â¬‡ï¸ Ø®Ø±ÙˆØ¬ÛŒ CSV</button>
        <button class="btn danger" id="btnReset">ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³</button>
        <button class="btn" id="btnLogout">ğŸšª Ø®Ø±ÙˆØ¬</button>
        <button class="btn primary" id="btnNew">â• Ø«Ø¨Øª Ú©Ù„Ø§ÛŒÙ†Øª Ø¬Ø¯ÛŒØ¯</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>ÙÛŒÙ„ØªØ±Ù‡Ø§</h3>
        <div class="row">
          <select class="field" id="filterRequestType"></select>
          <select class="field" id="filterCountry"></select>
          <select class="field" id="filterStatus"></select>
          <select class="field" id="filterAssignee"></select>
          <input class="field" id="filterSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ù†Ø§Ù…ØŒ Ù¾Ø§Ø³Ù¾ÙˆØ±ØªØŒ ØªÙ„ÙÙ†ØŒ Ø§ÛŒÙ…ÛŒÙ„ØŒ Ú©Ø¯ Ø¯Ø§Ø®Ù„ÛŒ..." />
        </div>
        <p class="hint">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ú¯Ø³ØªØ±Ø´: ÙÛŒÙ„ØªØ± Â«Ø¨Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ®Â»ØŒ Â«Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§Â»ØŒ Ùˆ Â«Ù…Ø±Ø­Ù„Ù‡ Ù¾Ø±ÙˆÙ†Ø¯Ù‡Â».</p>
      </div>

      <div class="card">
        <h3>Ø¢Ù…Ø§Ø± Ø³Ø±ÛŒØ¹</h3>
        <div class="kpis">
          <div class="kpi"><div class="v" id="kpiTotal">0</div><div class="l">Ú©Ù„ Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§</div></div>
          <div class="kpi"><div class="v" id="kpiActive">0</div><div class="l">ÙØ¹Ø§Ù„</div></div>
          <div class="kpi"><div class="v" id="kpiLead">0</div><div class="l">Ù„ÛŒØ¯</div></div>
          <div class="kpi"><div class="v" id="kpiSubmitted">0</div><div class="l">Ø«Ø¨Øª/Ø³Ø§Ø¨Ù…ÛŒØªâ€ŒØ´Ø¯Ù‡</div></div>
        </div>
      </div>

      <div class="card">
        <h3>ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø·Ø±Ø§Ø­ÛŒ (Ø§ØªØµØ§Ù„ Ø¢ÛŒÙ†Ø¯Ù‡)</h3>
        <div class="muted" style="line-height:1.8">
          â€¢ Ù‡Ø± Ú©Ù„Ø§ÛŒÙ†Øª ÛŒÚ© <b>client_id</b> Ø¯Ø§Ø±Ø¯.<br/>
          â€¢ Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ùˆ ÙØ±Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ø¯ÛŒ Ø¨Ø§ Ù‡Ù…ÛŒÙ† ID Ù„ÛŒÙ†Ú© Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.<br/>
          â€¢ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Â«Ú†Ú©â€ŒÙ„ÛŒØ³ØªÂ» Ùˆ Â«Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ø¯ÛŒÂ» Ø§Ù„Ø§Ù† Ù„ÛŒÙ†Ú© Ù†Ù…ÙˆÙ†Ù‡ Ù…ÛŒâ€ŒØ²Ù†Ù†Ø¯.
        </div>
      </div>

      <div class="card">
        <h3>Ø§ÛŒØ¯Ù‡ Ø®ÙÙ† Ø¢Ù…Ø§Ø¯Ù‡ ØªÙˆØ³Ø¹Ù‡</h3>
        <div class="muted" style="line-height:1.8">
          â€¢ Pipeline Ú©Ø§Ù†Ø¨Ø§Ù† â€¢ Timeline â€¢ Versioning â€¢ Archive
        </div>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width: 180px;">Ú©Ø¯ Ø¯Ø§Ø®Ù„ÛŒ</th>
            <th>Ù†Ø§Ù…</th>
            <th style="width: 220px;">Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</th>
            <th style="width: 130px;">Ú©Ø´ÙˆØ±</th>
            <th style="width: 150px;">ÙˆØ¶Ø¹ÛŒØª</th>
            <th style="width: 150px;">Ù…Ø³Ø¦ÙˆÙ„</th>
            <th style="width: 160px;">Ø¢Ø®Ø±ÛŒÙ† Ø¢Ù¾Ø¯ÛŒØª</th>
            <th style="width: 330px;">Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="mhTitle" id="modalTitle">Ø«Ø¨Øª Ú©Ù„Ø§ÛŒÙ†Øª Ø¬Ø¯ÛŒØ¯</div>
        <button class="btn small" id="btnClose">âœ–ï¸ Ø¨Ø³ØªÙ†</button>
      </div>

      <div class="modalBody">
        <div class="formGrid">
          <div class="formRow">
            <div class="label">Ù†Ø§Ù… *</div>
            <input class="field" id="fFirstName" />
          </div>
          <div class="formRow">
            <div class="label">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</div>
            <input class="field" id="fLastName" />
          </div>
          <div class="formRow">
            <div class="label">ØªÙ„ÙÙ† *</div>
            <input class="field" id="fPhone" placeholder="Ù…Ø«Ø§Ù„: +98912..." />
          </div>

          <div class="formRow">
            <div class="label">Ø§ÛŒÙ…ÛŒÙ„</div>
            <input class="field" id="fEmail" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ" />
          </div>
          <div class="formRow">
            <div class="label">Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø§Ø³Ù¾ÙˆØ±Øª</div>
            <input class="field" id="fPassport" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ" />
          </div>
          <div class="formRow">
            <div class="label">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯</div>
            <input class="field" id="fDob" placeholder="YYYY-MM-DD (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" />
          </div>

          <div class="formRow">
            <div class="label">Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª *</div>
            <select class="field" id="fRequestType"></select>
          </div>
          <div class="formRow">
            <div class="label">Ú©Ø´ÙˆØ± Ù…Ø­Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª *</div>
            <select class="field" id="fCountry"></select>
          </div>
          <div class="formRow">
            <div class="label">ÙˆØ¶Ø¹ÛŒØª *</div>
            <select class="field" id="fStatus"></select>
          </div>

          <div class="formRow">
            <div class="label">Ù…Ø³Ø¦ÙˆÙ„ Ù¾Ø±ÙˆÙ†Ø¯Ù‡</div>
            <select class="field" id="fAssignee"></select>
          </div>
          <div class="formRow">
            <div class="label">ØªØ¹Ø¯Ø§Ø¯ Ù‡Ù…Ø±Ø§Ù‡Ø§Ù†</div>
            <input class="field" id="fDependents" type="number" min="0" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ" />
          </div>
          <div class="formRow">
            <div class="label">Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)</div>
            <input class="field" id="fTags" placeholder="Ù…Ø«Ø§Ù„: VIP, ÙÙˆØ±ÛŒ, Ø§Ø³ØªØ§Ù†Ø¨ÙˆÙ„" />
          </div>

          <div class="formRow" style="grid-column: 1 / -1;">
            <div class="label">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</div>
            <textarea class="field" id="fNotes" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ"></textarea>
          </div>

          <div class="formRow" style="grid-column: 1 / -1;">
            <div class="label">Ù„ÛŒÙ†Ú© Ù¾ÙˆØ´Ù‡ Ù¾Ø±ÙˆÙ†Ø¯Ù‡</div>
            <input class="field" id="fFolderLink" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ" />
          </div>
        </div>

        <p class="hint">Ø¨Ø¹Ø¯Ø§Ù‹ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒÙ… Ø§ÛŒÙ† ÙØ±Ù… Ø±Ùˆ Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ú©Ù†ÛŒÙ…: (Û±) Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡ (Û²) Ø³Ø§Ø®Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ú†Ú©â€ŒÙ„ÛŒØ³Øª/Ù¾Ø±ÙˆÙØ§ÛŒÙ„.</p>
      </div>

      <div class="modalFooter">
        <button class="btn" id="btnSaveOpen">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÙ†Ø¯Ù‡</button>
        <button class="btn primary" id="btnSave">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="t" id="toastTitle"></div>
    <div class="d" id="toastDesc"></div>
  </div>



<script src="js/auth.js"></script>
<script>
const REQUEST_TYPES = [
  { value: "ALL", label: "Ù‡Ù…Ù‡" },
  { value: "NLV", label: "Ø§Ù‚Ø§Ù…Øª ØªÙ…Ú©Ù† Ù…Ø§Ù„ÛŒ" },
  { value: "DN_CONSULATE", label: "Ø§Ù‚Ø§Ù…Øª Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ù†ÙˆÙ…Ø¯ Ø§Ø² Ø³ÙØ§Ø±Øª" },
  { value: "DN_UGE", label: "Ø§Ù‚Ø§Ù…Øª Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ù†ÙˆÙ…Ø¯ Ø§Ø² Ø§Ø¯Ø§Ø±Ù‡ Ù…Ù‡Ø§Ø¬Ø±Øª (Ø§Ø³Ù¾Ø§Ù†ÛŒØ§)" },
  { value: "SELF_EMP", label: "Ø§Ù‚Ø§Ù…Øª Ø®ÙˆØ¯ Ø§Ø´ØªØºØ§Ù„ÛŒ" },
  { value: "STUDENT", label: "Ø§Ù‚Ø§Ù…Øª ØªØ­ØµÛŒÙ„ÛŒ" },
  { value: "TOURIST", label: "ÙˆÛŒØ²Ø§ÛŒ ØªÙˆØ±ÛŒØ³ØªÛŒ" },
];

const COUNTRIES = [
  { value: "ALL", label: "Ù‡Ù…Ù‡" },
  { value: "SPAIN", label: "Ø§Ø³Ù¾Ø§Ù†ÛŒØ§" },
  { value: "IRAN", label: "Ø§ÛŒØ±Ø§Ù†" },
  { value: "TURKEY", label: "ØªØ±Ú©ÛŒÙ‡" },
  { value: "UAE", label: "Ø§Ù…Ø§Ø±Ø§Øª" },
  { value: "IRAQ", label: "Ø¹Ø±Ø§Ù‚" },
  { value: "OTHER", label: "Ø³Ø§ÛŒØ±" },
];

const STATUSES = [
  { value: "ALL", label: "Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§" },
  { value: "LEAD", label: "Ù„ÛŒØ¯" },
  { value: "PREP", label: "Ø¯Ø±Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ" },
  { value: "APPOINTMENT", label: "ÙˆÙ‚Øª Ú¯Ø±ÙØªÙ‡â€ŒØ´Ø¯Ù‡" },
  { value: "SUBMITTED", label: "Ø«Ø¨Øª/Ø³Ø§Ø¨Ù…ÛŒØªâ€ŒØ´Ø¯Ù‡" },
  { value: "DEFICIENCY", label: "Ù†Ù‚Øµ Ù…Ø¯Ø§Ø±Ú©" },
  { value: "APPROVED", label: "ØªØ§ÛŒÛŒØ¯" },
  { value: "REJECTED", label: "Ø±Ø¯" },
  { value: "CANCELLED", label: "Ú©Ù†Ø³Ù„" },
  { value: "ARCHIVED", label: "Ø¢Ø±Ø´ÛŒÙˆ" },
];

const ASSIGNEES = [
  { value: "ALL", label: "Ù‡Ù…Ù‡ Ù…Ø³Ø¦ÙˆÙ„â€ŒÙ‡Ø§" },
  { value: "MEHRZAD", label: "Mehrzad" },
  { value: "BAHAREH", label: "Bahareh" },
  { value: "SAMIRA", label: "Samira" },
  { value: "HESAM", label: "Hesam" },
  { value: "IRFAN", label: "Irfan" },
  { value: "NONE", label: "Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø¦ÙˆÙ„" },
];

const DB_NAME = "aftab_clients_db";
const DB_VERSION = 1;
const STORE = "clients";

function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onerror = () => reject(req.error);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)){
        const store = db.createObjectStore(STORE, { keyPath: "id" });
        store.createIndex("internalCode", "internalCode", { unique: true });
        store.createIndex("lastUpdatedAt", "updatedAt", { unique: false });
        store.createIndex("requestType", "requestType", { unique: false });
        store.createIndex("country", "country", { unique: false });
        store.createIndex("status", "status", { unique: false });
        store.createIndex("assignee", "assignee", { unique: false });
        store.createIndex("archived", "archived", { unique: false });
      }
    };
    req.onsuccess = () => resolve(req.result);
  });
}

async function dbGetAll(){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readonly");
    const store = tx.objectStore(STORE);
    const req = store.getAll();
    req.onerror = () => reject(req.error);
    req.onsuccess = () => resolve(req.result || []);
  });
}

async function dbPut(client){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readwrite");
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
    tx.objectStore(STORE).put(client);
  });
}

async function dbDeleteAll(){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readwrite");
    const store = tx.objectStore(STORE);
    const req = store.clear();
    req.onerror = () => reject(req.error);
    req.onsuccess = () => resolve(true);
  });
}

const $ = (id) => document.getElementById(id);

function uuid(){
  return crypto.randomUUID ? crypto.randomUUID() : "id-" + Math.random().toString(16).slice(2) + Date.now();
}
function nowISO(){ return new Date().toISOString(); }
function fmtDate(iso){
  if(!iso) return "â€”";
  const d = new Date(iso);
  return d.toLocaleString("fa-IR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
}
function mapLabel(arr, value){
  const found = arr.find(x => x.value === value);
  return found ? found.label : value;
}
function statusTagClass(status){
  if (status === "APPROVED") return "ok";
  if (status === "DEFICIENCY" || status === "APPOINTMENT") return "warn";
  if (status === "REJECTED" || status === "CANCELLED") return "bad";
  return "";
}
function toast(title, desc){
  $("toastTitle").textContent = title;
  $("toastDesc").textContent = desc || "";
  $("toast").style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(() => $("toast").style.display = "none", 2400);
}
function sanitize(str){ return (str || "").toString().trim(); }
function makeInternalCode(seq){
  const year = new Date().getFullYear();
  return `ALG-${year}-${String(seq).padStart(6,"0")}`;
}
function toCsv(rows){
  const esc = (v) => `"${String(v ?? "").replace(/"/g, '""')}"`;
  const headers = ["internalCode","firstName","lastName","phone","email","passportNo","requestType","country","status","assignee","updatedAt","createdAt","tags","notes","folderLink","dependents"];
  const lines = [headers.map(esc).join(",")];
  for(const r of rows){
    lines.push(headers.map(h => esc(r[h])).join(","));
  }
  return lines.join("\n");
}
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

let allClients = [];
let editingId = null;

function fillSelect(el, options){
  el.innerHTML = "";
  for (const opt of options){
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.label;
    el.appendChild(o);
  }
}

function setupFilters(){
  fillSelect($("filterRequestType"), REQUEST_TYPES);
  fillSelect($("filterCountry"), COUNTRIES);
  fillSelect($("filterStatus"), STATUSES);
  fillSelect($("filterAssignee"), ASSIGNEES);

  $("filterRequestType").value = "ALL";
  $("filterCountry").value = "ALL";
  $("filterStatus").value = "ALL";
  $("filterAssignee").value = "ALL";

  const rerender = () => renderTable();
  ["filterRequestType","filterCountry","filterStatus","filterAssignee"].forEach(id => $(id).addEventListener("change", rerender));
  $("filterSearch").addEventListener("input", rerender);
}

function setupFormSelects(){
  fillSelect($("fRequestType"), REQUEST_TYPES.filter(x => x.value !== "ALL"));
  fillSelect($("fCountry"), COUNTRIES.filter(x => x.value !== "ALL"));
  fillSelect($("fStatus"), STATUSES.filter(x => x.value !== "ALL"));
  fillSelect($("fAssignee"), ASSIGNEES.filter(x => x.value !== "ALL"));
  $("fAssignee").value = "NONE";
  $("fStatus").value = "LEAD";
}

function openModal(mode){
  $("modalOverlay").style.display = "flex";
  document.body.style.overflow = "hidden";
  if (mode === "new"){
    $("modalTitle").textContent = "Ø«Ø¨Øª Ú©Ù„Ø§ÛŒÙ†Øª Ø¬Ø¯ÛŒØ¯";
    editingId = null;
    clearForm();
  }
}
function closeModal(){
  $("modalOverlay").style.display = "none";
  document.body.style.overflow = "";
}
function clearForm(){
  ["fFirstName","fLastName","fPhone","fEmail","fPassport","fDob","fDependents","fTags","fNotes","fFolderLink"].forEach(id => $(id).value = "");
  $("fRequestType").value = "NLV";
  $("fCountry").value = "SPAIN";
  $("fStatus").value = "LEAD";
  $("fAssignee").value = "NONE";
}
function setForm(client){
  $("fFirstName").value = client.firstName || "";
  $("fLastName").value = client.lastName || "";
  $("fPhone").value = client.phone || "";
  $("fEmail").value = client.email || "";
  $("fPassport").value = client.passportNo || "";
  $("fDob").value = client.dob || "";
  $("fRequestType").value = client.requestType || "NLV";
  $("fCountry").value = client.country || "SPAIN";
  $("fStatus").value = client.status || "LEAD";
  $("fAssignee").value = client.assignee || "NONE";
  $("fDependents").value = (client.dependents ?? "");
  $("fTags").value = (client.tags || []).join(", ");
  $("fNotes").value = client.notes || "";
  $("fFolderLink").value = client.folderLink || "";
}
function getForm(){
  const firstName = sanitize($("fFirstName").value);
  const lastName = sanitize($("fLastName").value);
  const phone = sanitize($("fPhone").value);
  const email = sanitize($("fEmail").value);
  const passportNo = sanitize($("fPassport").value);
  const dob = sanitize($("fDob").value);
  const requestType = $("fRequestType").value;
  const country = $("fCountry").value;
  const status = $("fStatus").value;
  const assignee = $("fAssignee").value;
  const dependents = $("fDependents").value === "" ? null : Number($("fDependents").value);
  const tags = sanitize($("fTags").value).split(",").map(x => x.trim()).filter(Boolean);
  const notes = sanitize($("fNotes").value);
  const folderLink = sanitize($("fFolderLink").value);
  return { firstName, lastName, phone, email, passportNo, dob, requestType, country, status, assignee, dependents, tags, notes, folderLink };
}
function validateForm(data){
  if (!data.firstName) return "Ù†Ø§Ù… Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.";
  if (!data.lastName) return "Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.";
  if (!data.phone) return "ØªÙ„ÙÙ† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.";
  if (!data.requestType) return "Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.";
  if (!data.country) return "Ú©Ø´ÙˆØ± Ù…Ø­Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.";
  if (!data.status) return "ÙˆØ¶Ø¹ÛŒØª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.";
  return null;
}

function matchesFilters(client){
  const ft = $("filterRequestType").value;
  const fc = $("filterCountry").value;
  const fs = $("filterStatus").value;
  const fa = $("filterAssignee").value;
  const q = sanitize($("filterSearch").value).toLowerCase();

  if (fs === "ARCHIVED"){
    if (!client.archived) return false;
  } else {
    if (client.archived) return false;
  }
  if (ft !== "ALL" && client.requestType !== ft) return false;
  if (fc !== "ALL" && client.country !== fc) return false;
  if (fs !== "ALL" && fs !== "ARCHIVED" && client.status !== fs) return false;
  if (fa !== "ALL"){
    if (fa === "NONE" && client.assignee !== "NONE") return false;
    if (fa !== "NONE" && client.assignee !== fa) return false;
  }
  if (q){
    const hay = [
      client.internalCode, client.firstName, client.lastName,
      client.phone, client.email, client.passportNo,
      mapLabel(REQUEST_TYPES, client.requestType),
      mapLabel(COUNTRIES, client.country),
      mapLabel(STATUSES, client.status),
      mapLabel(ASSIGNEES, client.assignee),
      (client.tags || []).join(" "),
      client.notes
    ].join(" ").toLowerCase();
    if (!hay.includes(q)) return false;
  }
  return true;
}

function renderKPIs(){
  const total = allClients.length;
  const active = allClients.filter(c => !c.archived).length;
  const lead = allClients.filter(c => !c.archived && c.status === "LEAD").length;
  const submitted = allClients.filter(c => !c.archived && c.status === "SUBMITTED").length;
  $("kpiTotal").textContent = total;
  $("kpiActive").textContent = active;
  $("kpiLead").textContent = lead;
  $("kpiSubmitted").textContent = submitted;
}

function renderTable(){
  renderKPIs();
  const tbody = $("tbody");
  tbody.innerHTML = "";
  const rows = allClients.filter(matchesFilters).sort((a,b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));
  if (!rows.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="8" style="padding:18px; color: var(--muted);">Ù‡ÛŒÚ† Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td>`;
    tbody.appendChild(tr);
    return;
  }
  for(const c of rows){
    const tr = document.createElement("tr");
    const fullName = `${c.firstName || ""} ${c.lastName || ""}`.trim();
    const reqLabel = mapLabel(REQUEST_TYPES, c.requestType);
    const countryLabel = mapLabel(COUNTRIES, c.country);
    const statusLabel = mapLabel(STATUSES, c.status);
    const assigneeLabel = mapLabel(ASSIGNEES, c.assignee);
    const tagClass = statusTagClass(c.status);

    tr.innerHTML = `
      <td class="nowrap">
        <div style="display:flex;flex-direction:column;gap:4px;">
          <div><b>${c.internalCode || "â€”"}</b></div>
          <div class="muted">ID: ${c.id.slice(0,8)}...</div>
        </div>
      </td>
      <td>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <div><b>${fullName || "â€”"}</b></div>
          <div class="muted">${c.phone || "â€”"} ${c.email ? " â€¢ " + c.email : ""}</div>
          <div class="muted">${c.passportNo ? "Ù¾Ø§Ø³Ù¾ÙˆØ±Øª: " + c.passportNo : ""}</div>
        </div>
      </td>
      <td>${reqLabel}</td>
      <td>${countryLabel}</td>
      <td>
        <span class="tag ${tagClass}">${statusLabel}</span>
        ${c.archived ? `<span class="tag bad" style="margin-inline-start:6px;">Ø¢Ø±Ø´ÛŒÙˆ</span>` : ""}
      </td>
      <td>${assigneeLabel}</td>
      <td class="nowrap">${fmtDate(c.updatedAt)}</td>
      <td>
        <div class="cell-actions">
          <button class="btn small ok" data-act="open" data-id="${c.id}">ğŸ“„ Ù¾Ø±ÙˆÙ†Ø¯Ù‡</button>
          <button class="btn small" data-act="checklist" data-id="${c.id}">âœ… Ú†Ú©â€ŒÙ„ÛŒØ³Øª</button>
          <button class="btn small" data-act="profile" data-id="${c.id}">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ø¯ÛŒ</button>
          <button class="btn small" data-act="edit" data-id="${c.id}">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
          ${
            c.archived
              ? `<button class="btn small" data-act="unarchive" data-id="${c.id}">â™»ï¸ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ</button>`
              : `<button class="btn small danger" data-act="archive" data-id="${c.id}">ğŸ—„ï¸ Ø¢Ø±Ø´ÛŒÙˆ</button>`
          }
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

function bindTableActions(){
  $("tbody").addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    const client = allClients.find(x => x.id === id);
    if(!client) return;

    if (act === "edit"){
      editingId = id;
      $("modalTitle").textContent = `ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù„Ø§ÛŒÙ†Øª (${client.internalCode})`;
      setForm(client);
      $("modalOverlay").style.display = "flex";
      document.body.style.overflow = "hidden";
      return;
    }
    if (act === "archive"){
      client.archived = true;
      client.updatedAt = nowISO();
      await dbPut(client);
      toast("Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯", `${client.internalCode} Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯.`);
      await refresh();
      return;
    }
    if (act === "unarchive"){
      client.archived = false;
      client.updatedAt = nowISO();
      await dbPut(client);
      toast("Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø´Ø¯", `${client.internalCode} ÙØ¹Ø§Ù„ Ø´Ø¯.`);
      await refresh();
      return;
    }

    if (act === "open"){
      toast("Ù†Ù…ÙˆÙ†Ù‡ Ù„ÛŒÙ†Ú© Ù¾Ø±ÙˆÙ†Ø¯Ù‡", "Ø¨Ø¹Ø¯Ø§Ù‹ Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ ÙˆØµÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….");
      window.open(`client_profile.html?client_id=${encodeURIComponent(client.id)}`, "_blank");
      return;
    }
    if (act === "checklist"){
      toast("Ù†Ù…ÙˆÙ†Ù‡ Ù„ÛŒÙ†Ú© Ú†Ú©â€ŒÙ„ÛŒØ³Øª", "Ø¨Ø¹Ø¯Ø§Ù‹ Ø¨Ù‡ Ú†Ú©â€ŒÙ„ÛŒØ³Øª ÙˆØ§Ù‚Ø¹ÛŒ ÙˆØµÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….");
      window.open(`checklist.html?client_id=${encodeURIComponent(client.id)}&type=${encodeURIComponent(client.requestType)}`, "_blank");
      return;
    }
    if (act === "profile"){
      toast("Ù†Ù…ÙˆÙ†Ù‡ Ù„ÛŒÙ†Ú© Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ø¯ÛŒ", "Ø¨Ø¹Ø¯Ø§Ù‹ Ø¨Ù‡ ÙØ±Ù… ÙˆØ§Ù‚Ø¹ÛŒ ÙˆØµÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….");
      window.open(`personal_info.html?client_id=${encodeURIComponent(client.id)}`, "_blank");
      return;
    }
  });
}

async function refresh(){ allClients = await dbGetAll(); renderTable(); }

async function saveClient(openAfter){
  const data = getForm();
  const err = validateForm(data);
  if (err){ toast("Ø®Ø·Ø§", err); return; }
  const now = nowISO();

  if (editingId){
    const client = allClients.find(x => x.id === editingId);
    if(!client){ toast("Ø®Ø·Ø§", "Ú©Ù„Ø§ÛŒÙ†Øª Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯."); return; }
    const updated = { ...client, ...data, tags: data.tags, dependents: data.dependents, updatedAt: now };
    await dbPut(updated);
    toast("Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯", `${updated.internalCode} Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.`);
    closeModal();
    await refresh();
    if(openAfter) window.open(`client_profile.html?client_id=${encodeURIComponent(updated.id)}`, "_blank");
    return;
  }

  const seq = allClients.length + 1;
  const client = { id: uuid(), internalCode: makeInternalCode(seq), createdAt: now, updatedAt: now, archived:false, ...data, tags: data.tags };
  await dbPut(client);
  toast("Ø«Ø¨Øª Ø´Ø¯", `${client.internalCode} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`);
  closeModal();
  await refresh();
  if(openAfter) window.open(`client_profile.html?client_id=${encodeURIComponent(client.id)}`, "_blank");
}

async function exportCSV(){
  const rows = await dbGetAll();
  downloadText(`clients_export_${new Date().getFullYear()}.csv`, toCsv(rows));
  toast("Ø®Ø±ÙˆØ¬ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯", "ÙØ§ÛŒÙ„ CSV Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯.");
}
async function resetDB(){
  const ok = confirm("Ø§ÛŒÙ† Ú©Ø§Ø± ØªÙ…Ø§Ù… Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ");
  if(!ok) return;
  await dbDeleteAll();
  toast("Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø´Ø¯", "Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø®Ø§Ù„ÛŒ Ø´Ø¯.");
  await refresh();
}

async function init(){
  setupFilters();
  setupFormSelects();
  bindTableActions();

  $("btnNew").addEventListener("click", () => openModal("new"));
  $("btnClose").addEventListener("click", closeModal);
  $("modalOverlay").addEventListener("click", (e) => { if(e.target.id === "modalOverlay") closeModal(); });

  $("btnSave").addEventListener("click", () => saveClient(false));
  $("btnSaveOpen").addEventListener("click", () => saveClient(true));

  $("btnExport").addEventListener("click", exportCSV);
  $("btnReset").addEventListener("click", resetDB);

  $("btnLogout").addEventListener("click", async () => {
    const { authLog } = window.ALG_AUTH || {};
    const company = localStorage.getItem("alg_session_company") || "";
    const username = localStorage.getItem("alg_session_username") || "";
    const role = localStorage.getItem("alg_session_role") || "";
    const token = localStorage.getItem("alg_session_token") || "";
    try{
      if(authLog) await authLog({ type:"LOGOUT", company, username, role, page:"clients_db.html", sessionToken: token, message:"logout_clicked" });
    }catch(e){}

    ["alg_session_company","alg_session_username","alg_session_role","alg_session_token","alg_session_loginAt","alg_session_expiresAt"]
      .forEach(k => localStorage.removeItem(k));
    window.location.href = "login.html";
  });

  window.addEventListener("keydown", (e) => { if (e.key === "Escape" && $("modalOverlay").style.display === "flex") closeModal(); });

  await refresh();
}
init();
</script>
</body>
</html>
